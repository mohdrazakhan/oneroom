rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- WEBSITE STATS RULES ---
    // Allow everyone to READ stats (public data for the website)
    // Only allow Cloud Functions to WRITE (via Admin SDK)
    match /appStats/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // --- APP RULES (MANDATORY) ---

    // Allow collection group queries on taskInstances where the caller is the assignee
    // This ensures collectionGroup reads don't fail due to membership checks
    match /{path=**}/taskInstances/{instanceId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.assignedTo;
    }
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is a member of the room
    function isMemberOfRoom(roomId) {
      return isSignedIn() && 
             request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.members;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      // AND authenticated users can read other users' profiles (for displaying names)
      allow read: if isSignedIn();
      
      // Users can create and update their own profile
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      
      // No one can delete user profiles
      allow delete: if false;
      
      // FCM tokens subcollection (for push notifications)
      match /tokens/{tokenId} {
        // Users can read, create, update, and delete their own tokens
        allow read, create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }
    }
    
    // Rooms collection
    match /rooms/{roomId} {
      // Anyone authenticated can create a room
      allow create: if isSignedIn() && 
                       request.auth.uid == request.resource.data.createdBy &&
                       request.auth.uid in request.resource.data.members;
      
      // Anyone authenticated can read room data (needed for join functionality)
      // This allows users to lookup a room before joining
      allow read: if isSignedIn();
      
      // Members can update room (e.g., add new members)
      // Also allow update if user is adding themselves to members array
      allow update: if isSignedIn() && (
        request.auth.uid in resource.data.members ||
        (request.auth.uid in request.resource.data.members && 
         request.resource.data.members.size() == resource.data.members.size() + 1)
      );
      
      // Only creator can delete the room
      allow delete: if isSignedIn() && request.auth.uid == resource.data.createdBy;
      
      // Expenses subcollection
      match /expenses/{expenseId} {
        // Members can create expenses
        allow create: if isMemberOfRoom(roomId);
        
        // Members can read expenses
        allow read: if isMemberOfRoom(roomId);
        
        // Members can update and delete their own expenses
        allow update, delete: if isMemberOfRoom(roomId);
      }
      
      // Task categories subcollection
      match /task_categories/{categoryId} {
        // Members can create categories
        allow create: if isMemberOfRoom(roomId);
        
        // Members can read categories
        allow read: if isMemberOfRoom(roomId);
        
        // Members can update and delete categories
        allow update, delete: if isMemberOfRoom(roomId);
      }
      
      // Tasks subcollection
      match /tasks/{taskId} {
        // Members can create tasks
        allow create: if isMemberOfRoom(roomId);
        
        // Members can read tasks
        allow read: if isMemberOfRoom(roomId);
        
        // Members can update and delete tasks
        allow update, delete: if isMemberOfRoom(roomId);
      }

      // Chats subcollection (room chat messages)
      match /chats/{messageId} {
        // Members can read and create chat messages
        allow read: if isMemberOfRoom(roomId);
        allow create: if isMemberOfRoom(roomId);

        // Members can update their own messages (for editing)
        // Or update any message for poll voting, read receipts, or hiding
        allow update: if isMemberOfRoom(roomId) && (
          // allow vote updates on polls
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pollOptions']) ||
          // allow read receipts (adding to readBy array)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
          // allow hiding messages (adding to hiddenBy array)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['hiddenBy']) ||
          // allow edits only by the original sender (support legacy sender field names)
          request.auth.uid == resource.data.senderId ||
          request.auth.uid == resource.data.userId ||
          request.auth.uid == resource.data.uid ||
          request.auth.uid == resource.data.sentBy ||
          request.auth.uid == resource.data.authorId
        );

        // Temporarily allow any room member to delete any chat message
        // to unblock message cleanup while we reconcile legacy data shapes.
        // TODO: tighten to only author/recipient after data backfill.
        allow delete: if isMemberOfRoom(roomId);
      }

      // Payments subcollection (cash settlements between members)
      match /payments/{paymentId} {
        // Members can create payment records
        allow create: if isMemberOfRoom(roomId);
        
        // Members can read payment history
        allow read: if isMemberOfRoom(roomId);
        
        // Members can delete payments (in case of mistakes)
        allow delete: if isMemberOfRoom(roomId);
        
        // Prevent updates to maintain payment integrity
        allow update: if false;
      }

      // Task instances subcollection (scheduled task occurrences)
      match /taskInstances/{instanceId} {
        // Members can create task instances
        allow create: if isMemberOfRoom(roomId);
        
        // Read task instances
        // - Members of the room can read
        // - Additionally, allow the assigned user to read their own instances even if no longer a member
        //   This prevents collectionGroup queries filtered by assignedTo from failing due to stale data
        allow read: if isMemberOfRoom(roomId) || (
          isSignedIn() && request.auth.uid == resource.data.assignedTo
        );
        
        // Members can update task instances (mark complete, swap assignments, etc.)
        allow update: if isMemberOfRoom(roomId);
        
        // Members can delete task instances
        allow delete: if isMemberOfRoom(roomId);
      }

      // Point Transactions (gamification)
      match /pointTransactions/{transactionId} {
        // Members can read transactions
        allow read: if isMemberOfRoom(roomId);
        
        // Members can create transactions (e.g. skipping tasks, bonuses)
        allow create: if isMemberOfRoom(roomId);
        
        // No updates allowed (immutable history)
        allow update: if false;
        
        // Allow delete if needed? For now, no.
        allow delete: if false;
      }

      // Immutable Activity/Audit Log subcollection
      // - Members of the room can read all audit events for transparency
      // - Only members can CREATE new entries (app writes on add/edit/delete)
      // - No one can UPDATE or DELETE existing audit entries (immutability)
      match /auditLog/{logId} {
        allow read: if isMemberOfRoom(roomId);
        allow create: if isMemberOfRoom(roomId);
        allow update, delete: if false;
      }
    }
    
    // Notifications collection (top-level, not a subcollection)
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      
      // Any authenticated user can create notifications
      // This allows the app to create notifications for other users
      allow create: if isSignedIn() &&
                       request.resource.data.userId is string &&
                       request.resource.data.roomId is string &&
                       request.resource.data.type is string &&
                       request.resource.data.title is string &&
                       request.resource.data.message is string &&
                       request.resource.data.isRead == false &&
                       request.resource.data.createdAt is timestamp;
      
      // Users can only update their own notifications
      // Prevents changing roomId, userId, type, etc.
      allow update: if isSignedIn() && 
                       request.auth.uid == resource.data.userId &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.roomId == resource.data.roomId &&
                       request.resource.data.type == resource.data.type;
      
      // Users can only delete their own notifications
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Bug reports collection (top-level)
    match /bug_reports/{reportId} {
      // Allow authenticated users to create bug reports
      allow create: if isSignedIn() &&
        request.resource.data.title is string && request.resource.data.title.size() > 0 &&
        request.resource.data.description is string && request.resource.data.description.size() > 5 &&
        request.resource.data.contact is string && request.resource.data.contact.size() > 0 &&
        request.resource.data.userId is string && request.resource.data.userId == request.auth.uid &&
        request.resource.data.attachments is list &&
        request.resource.data.createdAt is timestamp;

      // Allow reporter to read their own reports
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;

      // No updates or deletes by clients (immutable once submitted)
      allow update, delete: if false;
    }
  }
}
